// Schema SQLite para desenvolvimento local
// Este arquivo substitui o schema.prisma quando usando SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modelo User
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      String   @default("CUSTOMER") // CUSTOMER, STAFF, ADMIN
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  orders Order[]
  finalizedOrders Order[] @relation("FinalizedOrders")
  tables Table[]
  cart   Cart?
  stockMovements StockMovement[]
  orderLogs OrderLog[] @relation("OrderLogs")
  notifications Notification[]

  // Índices para performance
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([role, isActive])
  @@map("users")
}

// Modelo Category
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  color       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relacionamentos
  products Product[]

  @@map("categories")
}

// Modelo Product
model Product {
  id              String    @id @default(cuid())
  name            String
  description     String
  price           Float     // Usando Float em vez de Decimal para SQLite
  categoryId      String
  preparationTime Int       @default(15) // em minutos
  allergens       String?
  isAvailable     Boolean   @default(true)
  imageUrl        String?
  
  // Campos de estoque
  stockQuantity   Int?      @default(0)    // Quantidade em estoque
  minStockLevel   Int?      @default(5)    // Nível mínimo de estoque
  trackStock      Boolean   @default(false) // Se deve controlar estoque
  maxStockLevel   Int?      @default(100)  // Nível máximo de estoque
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relacionamentos
  category Category @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  cartItems CartItem[]
  stockMovements StockMovement[]

  // Índices para performance
  @@index([categoryId])
  @@index([isAvailable])
  @@index([price])
  @@index([name])
  @@index([categoryId, isAvailable])
  @@index([name, isAvailable])
  @@index([trackStock])
  @@index([stockQuantity])
  @@map("products")
}

// Modelo Order
model Order {
  id              String   @id @default(cuid())
  userId          String
  status          String   @default("PENDENTE") // PENDENTE, CONFIRMADO, PREPARANDO, PRONTO, ENTREGUE, FINALIZADO, CANCELADO
  total           Float    // Usando Float em vez de Decimal para SQLite
  deliveryType    String   @default("RETIRADA") // RETIRADA, DELIVERY
  deliveryAddress String?
  paymentMethod   String   @default("DINHEIRO") // DINHEIRO, CARTAO, PIX
  isPaid          Boolean  @default(false) // Status de pagamento
  isReceived      Boolean  @default(false) // Se o pedido foi recebido pelo cliente
  isActive        Boolean  @default(true) // Status do pedido ativo/inativo
  notes           String?
  tableId         String?
  finalizedBy     String?  // ID do funcionário que finalizou o pedido
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  user User @relation(fields: [userId], references: [id])
  table Table? @relation(fields: [tableId], references: [id])
  items OrderItem[]
  finalizedByUser User? @relation("FinalizedOrders", fields: [finalizedBy], references: [id])
  logs OrderLog[]

  // Índices para performance
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([tableId])
  @@index([deliveryType])
  @@index([finalizedBy])
  @@index([isActive])
  @@index([status, tableId])
  @@index([userId, status])
  @@index([createdAt, status])
  @@index([tableId, status])
  @@index([isActive, status])
  @@index([userId, isActive])
  @@map("orders")
}

// Modelo OrderItem
model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float   // Preço no momento da compra
  notes     String?
  customizations String? // JSON serializado como string

  // Relacionamentos
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  // Índices para performance
  @@index([orderId])
  @@index([productId])
  @@index([orderId, productId])
  @@map("order_items")
}

// Modelo Cart (carrinho temporário)
model Cart {
  id        String     @id @default(cuid())
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@unique([userId]) // Um carrinho por usuário
  @@index([userId])
  @@index([createdAt])
  @@map("carts")
}

// Modelo CartItem (itens do carrinho)
model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  price     Float    // Preço no momento da adição
  notes     String?
  createdAt DateTime @default(now())

  // Relacionamentos
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  // Índices para performance
  @@unique([cartId, productId]) // Evita duplicação de produtos no carrinho
  @@index([cartId])
  @@index([productId])
  @@index([createdAt])
  @@map("cart_items")
}

// Modelo Table
model Table {
  id              String   @id @default(cuid())
  number          Int      @unique
  capacity        Int      @default(4)
  status          String   @default("LIVRE") // LIVRE, OCUPADA
  area            String?  // Área da mesa (ex: "Área VIP", "Terraço")
  qrCode          String?  // Código QR da mesa
  assignedTo      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  assignedUser User? @relation(fields: [assignedTo], references: [id])
  orders       Order[]

  // Índices para performance
  @@index([number])
  @@index([status])
  @@index([assignedTo])
  @@index([area])
  @@index([status, assignedTo])
  @@map("tables")
}

// Modelo StockMovement (movimentações de estoque)
model StockMovement {
  id          String   @id @default(cuid())
  productId   String
  type        String   // ENTRADA, SAIDA, AJUSTE
  quantity    Int      // Quantidade (positiva para entrada, negativa para saída)
  reason      String   // Motivo da movimentação
  reference   String?  // Referência (ex: número do pedido, nota fiscal)
  userId      String?  // Usuário que fez a movimentação
  notes       String?  // Observações adicionais
  createdAt   DateTime @default(now())

  // Relacionamentos
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id])

  // Índices para performance
  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([userId])
  @@index([productId, createdAt])
  @@index([type, createdAt])
  @@map("stock_movements")
}

// Modelo OrderLog (log de mudanças de status dos pedidos)
model OrderLog {
  id          String   @id @default(cuid())
  orderId     String
  userId      String?  // Usuário que fez a alteração
  action      String   // CREATE, UPDATE_STATUS, CANCEL, etc.
  oldValue    String?  // Valor anterior (JSON)
  newValue    String?  // Novo valor (JSON)
  field       String?  // Campo alterado (status, paymentMethod, etc.)
  reason      String?  // Motivo da alteração
  ipAddress   String?  // IP do usuário
  userAgent   String?  // User agent
  createdAt   DateTime @default(now())

  // Relacionamentos
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User? @relation("OrderLogs", fields: [userId], references: [id])

  // Índices para performance
  @@index([orderId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([orderId, createdAt])
  @@map("order_logs")
}

// Modelo Settings (Configurações do Sistema)
model Settings {
  id          String   @id @default(cuid())
  key         String   @unique // Chave única da configuração
  value       String   // Valor da configuração (JSON string)
  category    String   // Categoria: general, payment, printing, backup
  description String?  // Descrição da configuração
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Índices para performance
  @@index([category])
  @@index([key])
  @@index([category, isActive])
  @@map("settings")
}

// Modelo Notification (notificações do sistema)
model Notification {
  id          String   @id @default(cuid())
  userId      String?  // Usuário destinatário (null = todos os usuários)
  title       String   // Título da notificação
  message     String   // Mensagem da notificação
  type        String   // Tipo: order, stock, system, payment, etc.
  priority    String   @default("normal") // low, normal, high, urgent
  isRead      Boolean  @default(false)
  isActive    Boolean  @default(true)
  data        String?  // Dados adicionais (JSON string)
  expiresAt   DateTime? // Data de expiração da notificação
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices para performance
  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([isRead])
  @@index([isActive])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([type, isActive])
  @@index([expiresAt])
  @@map("notifications")
}

